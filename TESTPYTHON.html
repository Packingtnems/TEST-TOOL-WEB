<!DOCTYPE html>
<html lang="vi">
<head>
  <meta charset="UTF-8">
  <title>K·∫æT QU·∫¢ TEST</title>
  <style>
    /* Common styles */
    body { font-family: Arial, sans-serif; margin: 0; padding: 0; background: #f5f7fa; }
    .container { padding: 20px; }
    .tab-buttons { display: flex; gap: 10px; margin-bottom: 15px; }
    .tab-buttons button {
      padding: 10px 20px; border: none; border-radius: 6px;
      background: #34495e; color: #fff; cursor: pointer;
    }
    .tab-buttons button.active { background: #27ae60; }
    .tab-content { display: none; }
    .tab-content.active { display: block; }
    
    /* Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m */
    .app-container { display: flex; flex-direction: row; }
    .left, .right { padding: 20px; overflow-y: auto; }
    .left { width: 40%; border-right: 2px solid #ccc; position: relative; }
    .right { width: 60%; }
    label { font-weight: bold; display: block; margin: 10px 0 5px; }
    input, select { padding: 5px; width: 200px; margin-bottom: 10px; }
    button { padding: 8px 16px; margin: 6px; border-radius: 6px; border: 1px solid #333; font-size: 14px; cursor: pointer; }
    #okBtn { color: green; }
    #ngBtn { color: red; }
    #error { color: red; font-weight: bold; margin-top: 10px; }
    table { margin-top: 10px; border-collapse: collapse; width: 100%; }
    th, td { border: 1px solid #ccc; padding: 6px; text-align: center; }
    th { background: #eee; }
    .duplicate { background-color: #ffb3b3; }
    #loginScreen { margin-top: 50px; text-align: center; }
    .mainApp { display: none; }
    #clearLogBtn, #resetDataBtn { position: absolute; top: 12px; padding: 6px 12px; border: none; border-radius: 6px; cursor: pointer; }
    #clearLogBtn { right: 120px; background: #3498db; color: white; }
    #clearLogBtn:hover { background: #2980b9; }
    #resetDataBtn { right: 12px; background: #e74c3c; color: white; }
    #resetDataBtn:hover { background: #c0392b; }
    .stat { margin-top: 8px; font-size: 14px; }
    
    /* Tab 2: L·ªçc d·ªØ li·ªáu */
    .filter-container { display: flex; flex-wrap: wrap; gap: 15px; margin-bottom: 20px; }
    .filter-item { display: flex; flex-direction: column; }
    .filter-item label { font-size: 13px; color: #555; margin-bottom: 4px; }
    .filter-item input, .filter-item select {
      padding: 8px 10px; border-radius: 6px; border: 1px solid #ccc; min-width: 150px; background: #fff;
    }
    .button-container { display: flex; gap: 10px; margin-bottom: 20px; }
    .btn-filter {
      background: #34495e; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-filter:hover { background: #2c3e50; }
    .btn-download {
      background: #27ae60; color: #fff; padding: 10px 20px; border: none; border-radius: 6px; font-size: 14px; cursor: pointer;
    }
    .btn-download:hover { background: #1e874b; }
    
    /* Tab 3: Bi·ªÉu ƒë·ªì */
    .chart-container { margin-bottom: 30px; }
    .chart-container h3 { margin-bottom: 10px; }
    canvas { max-width: 100%; background: white; border: 1px solid #ddd; border-radius: 4px; padding: 10px; }
    
    /* Th√™m style cho th√¥ng b√°o */
    .sync-status {
      padding: 10px;
      margin: 10px 0;
      border-radius: 4px;
      display: none;
    }
    .sync-success {
      background-color: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .sync-error {
      background-color: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }

    /* Arduino Status */
    .arduino-status {
      padding: 8px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
    }
    .arduino-connected {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .arduino-disconnected {
      background: #f8d7da;
      color: #721c24;
      border: 1px solid #f5c6cb;
    }
    .arduino-connecting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }

    /* Software Test Status */
    .software-test-status {
      padding: 8px;
      margin: 10px 0;
      border-radius: 4px;
      font-weight: bold;
      text-align: center;
      font-size: 13px;
    }
    .software-ready {
      background: #d4edda;
      color: #155724;
      border: 1px solid #c3e6cb;
    }
    .software-waiting {
      background: #fff3cd;
      color: #856404;
      border: 1px solid #ffeaa7;
    }
  </style>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/clusterize.js@0.18.1/clusterize.min.js"></script>
</head>
<body>
     <div style="margin-top:20px; display:flex; gap:10px; ">
      <img src="logo.png" alt="Logo" style="height: 100px; width: auto; margin-right: 20px;">
      <h2>üìä K·∫æT QU·∫¢ TEST</h2>
      </div>
     </div>

    <div class="tab-buttons">
      <button id="btnTab1" class="active" onclick="showTab(1)">üìù Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</button>
      <button id="btnTab2" onclick="showTab(2)">üìë D·ªØ li·ªáu</button>
      <button id="btnTab3" onclick="showTab(3)">üìà Bi·ªÉu ƒë·ªì</button>
    </div>
    
    <!-- Tab 1: Ph√°n ƒë·ªãnh s·∫£n ph·∫©m -->
    <div id="tab1" class="tab-content active">
      <!-- M√†n h√¨nh ƒëƒÉng nh·∫≠p -->
      <div id="loginScreen">
        <h2>ƒêƒÉng nh·∫≠p</h2>
        <label for="loginUser">T√™n ƒëƒÉng nh·∫≠p</label>
        <input type="text" id="loginUser" placeholder="Nh·∫≠p m√£ s·ªë nh√¢n vi√™n">

        <label for="loginPass">M·∫≠t kh·∫©u</label>
        <input type="password" id="loginPass" placeholder="Nh·∫≠p m·∫≠t kh·∫©u">

        <label for="shift">Ch·ªçn ca</label>
        <select id="shift">
          <option value="Ca 1 (06:00-14:00)">Ca 1 (06:00 - 14:00)</option>
          <option value="Ca 2 (14:00-22:00)">Ca 2 (14:00 - 22:00)</option>
          <option value="Ca 1 d√†i (06:00-18:00)">Ca 1 d√†i (06:00 - 18:00)</option>
          <option value="Ca 2 d√†i (18:00-06:00)">Ca 2 d√†i (18:00 - 06:00 h√¥m sau)</option>
          <option value="Ca HC (08:00-16:30)">Ca HC (08:00 - 16:30)</option>
        </select>

        <label for="wo">S·ªë l·ªánh s·∫£n xu·∫•t (WO)</label>
        <input type="text" id="wo" placeholder="Nh·∫≠p s·ªë WO" oninput="this.value=this.value.toUpperCase()">

        <br>
        <button onclick="login()">ƒêƒÉng nh·∫≠p</button>
        <p id="loginError" style="color:red;"></p>
      </div>

      <!-- Giao di·ªán ch√≠nh -->
      <div id="mainApp" class="mainApp app-container">
        <!-- C·ªôt tr√°i -->
        <div class="left">
          <h2>Ph√°n ƒë·ªãnh s·∫£n ph·∫©m</h2>
          <button id="clearLogBtn" onclick="clearLogDisplay()">X√≥a log</button>
          <button id="resetDataBtn" onclick="resetAllData()">Reset d·ªØ li·ªáu</button>

          <!-- N√öT ARDUINO -->
          <button id="connectArduinoBtn" onclick="connectToArduino()" style="background: #9b59b6; color: white; margin: 5px;">
            üîå K·∫øt n·ªëi Arduino
          </button>
          
          <!-- TR·∫†NG TH√ÅI K·∫æT N·ªêI -->
          <div id="arduinoStatus" class="arduino-status arduino-disconnected">
            üî¥ Arduino: Ch∆∞a k·∫øt n·ªëi
          </div>

          <!-- PH·∫¶N M·ªÄM TEST -->
          <div id="softwareTestSection" style="margin: 15px 0; padding: 10px; background: #f8f9fa; border-radius: 5px;">
            <h4>üéØ Ph·∫ßn m·ªÅm Test</h4>
            
            <!-- N√∫t test t√≠n hi·ªáu -->
            <button id="testSignalBtn" onclick="testSoftwareSignal()" style="background: #e67e22; color: white; margin: 5px;">
              üß™ Test t√≠n hi·ªáu
            </button>
            
            <!-- Tr·∫°ng th√°i ph·∫ßn m·ªÅm test -->
            <div id="softwareStatus" class="software-test-status software-ready">
              ‚úÖ S·∫µn s√†ng nh·∫≠n t√≠n hi·ªáu
            </div>
            
            <!-- H∆∞·ªõng d·∫´n -->
            <div style="margin-top: 10px; font-size: 12px; text-align: left;">
              <p><b>H∆∞·ªõng d·∫´n:</b></p>
              <ul style="margin: 5px 0; padding-left: 15px;">
                <li><b>Ctrl+Shift+P</b>: T√≠n hi·ªáu PASS t·ª´ ph·∫ßn m·ªÅm</li>
                <li><b>Alt+O</b>: Nh·∫•n OK th·ªß c√¥ng</li>
                <li>Nh·∫≠p ƒë·ªß <b>M√£ h√†ng</b> v√† <b>QR Code</b> tr∆∞·ªõc</li>
              </ul>
            </div>
          </div>

          <p class="stat">üë§ Ng∆∞·ªùi ki·ªÉm tra: <b id="currentUser"></b></p>
          <p class="stat">üïí Ca: <b id="currentShift"></b></p>
          <p class="stat">üìã WO: <b id="currentWO"></b></p>
          <p class="stat">‚úÖ OK: <b id="okCount">0</b> | ‚ùå NG: <b id="ngCount">0</b></p>

          <label for="deliveryQty"><b>S·ªê L∆Ø·ª¢NG GIAO</b></label>
          <input type="number" id="deliveryQty" value="0" min="0" style="width:150px;">
          <p id="deliveryStatus" style="color:blue;font-weight:bold;"></p>

          <label for="mahang">M√£ h√†ng</label>
          <select id="mahang" onchange="updateQRCodeMaxLength()">
          <option value="">-- Ch·ªçn m√£ h√†ng --</option>
            <option value="ECM-2583-236">ECM-2583-236</option>
            <option value="ECM-2583-164">ECM-2583-164</option>
            <option value="ECM-2300">ECM-2300</option>
            <option value="ECM-2310">ECM-2310</option>
            <option value="IZ-1-R3">IZ-1-R3</option>
            <option value="RM-4K-R3">RM-4K-R3</option>
            <option value="AM-4-R3">AM-4-R3</option>
            <option value="P-7937">P-7937</option>
            <option value="P-8105">P-8105</option>
            <option value="P-8149">P-8149</option>
            <option value="BMS 85AH">BMS 85AH</option>
            <option value="BMS 57AH">BMS 57AH</option>
            <option value="CONTROLLER">CONTROLLER</option>
            <option value="CAS NEMO">CAS NEMO</option>
            <option value="CAS MINI-DI">CAS MINI-DI</option>
            <option value="CAS MINI-485">CAS MINI-485</option>
            <option value="BN 2573A">BN 2573A</option>
            <option value="OEM">OEM</option>
            
          </select>
          <p id="qrcodeLengthInfo" style="font-size: 12px; color: #666; margin-top: -5px; margin-bottom: 10px;"></p>
          <label for="qrcode">QR Code</label>
          <input type="text" id="qrcode" placeholder="Qu√©t QR code" oninput="this.value=this.value.toUpperCase()">

          <label for="loi">L·ªói / Ghi ch√∫</label>
          <div style="display: flex; gap: 10px;">
            <input list="errorList" id="loi" placeholder="Nh·∫≠p l·ªói (n·∫øu c√≥)">
            <input type="text" id="ghichu" placeholder="Nh·∫≠p ghi ch√∫ (n·∫øu c√≥)">
          </div>
          <datalist id="errorList">
            <option value="√ÅP CAO">√ÅP CAO</option>
            <option value="√ÅP TH·∫§P">√ÅP TH·∫§P</option>
            <option value="HALL SENSOR">HALL SENSOR</option>
            <option value="R CAO">R CAO</option>
            <option value="LAMDA FAIL">LAMDA FAIL</option>
            <option value="KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE">KH√îNG N·∫†P ƒê∆Ø·ª¢C CODE</option>
            <option value="KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH">KH√îNG K·∫æT N·ªêI ƒê∆Ø·ª¢C V·ªöI M√ÅY T√çNH</option>
            <option value="VƒÇN TAY GA KH√îNG L√äN">VƒÇN TAY GA KH√îNG L√äN</option>
            <option value="N·ªî T·ª§ NH·ªé">N·ªî T·ª§ NH·ªé</option>
            <option value="D√íNG CAO">D√íNG CAO</option>
            <option value="V DISCHARGE TH·∫§P">V DISCHARGE TH·∫§P</option>
            <option value="V CHARGE TH√ÇP">V CHARGE TH√ÇP</option>
            <option value="V > 30V">V > 30V</option>
            <option value="L·ªói 3M">L·ªói 3M</option>
            <option value="C13,C14">C13,C14</option>
            <option value="C5,C6">C5,C6</option>
            <option value="C12,C13">C12,C13</option>
            <option value="C23">C23</option>
            <option value="NTC1">NTC1</option>
            <option value="NTC2">NTC2</option>
            <option value="TOP AFE">TOP AFE</option>
          </datalist>

          <div>
            <button id="okBtn" onclick="saveData('OK')">OK</button>
            <button id="ngBtn" onclick="saveData('NG')">NG</button>
          </div>
        
          <p id="error"></p>

          <!-- Th√¥ng b√°o tr·∫°ng th√°i ƒë·ªìng b·ªô -->
          <div id="syncStatus" class="sync-status"></div>

          <div>
            <button onclick="exportCSV()">Xu·∫•t logfile</button>
            <button onclick="syncToSheet()">ƒê·ªìng b·ªô Google Sheets</button>
            <button onclick="endShiftReport()">B√°o c√°o cu·ªëi ca</button>
          </div>

          <!-- Bi·ªÉu ƒë·ªì realtime -->
          <div>
            <h3>B√°o c√°o real-time</h3>
            <div style="width: 200px; height: 200px;">
              <canvas id="chartOKNG"></canvas>
            </div>
          </div>
        </div>

        <!-- C·ªôt ph·∫£i -->
        <div class="right">
          <!-- B·ªô l·ªçc -->
          <div>
            <input type="text" id="searchBox" placeholder="T√¨m QR / M√£ h√†ng" onkeyup="renderTable()">
            <select id="filterResult" onchange="renderTable()">
              <option value="">--T·∫•t c·∫£--</option>
              <option value="OK">OK</option>
              <option value="NG">NG</option>
            </select>
          </div>
          <table id="logTable">
            <thead>
              <tr>
                <th>M√£ h√†ng</th>
                <th>QR Code</th>
                <th>Ph√¢n ƒë·ªãnh</th>
                <th>M√¥ t·∫£ l·ªói</th>
                <th>Ng√†y</th>
                <th>Gi·ªù</th>
                <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
                <th>M√£ nh√¢n vi√™n</th>
                <th>Shift</th>
                <th>PO</th>
                <th>Ghi ch√∫</th>
                <th>Thao t√°c</th>
              </tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>
    
    <!-- Tab 2: D·ªØ li·ªáu -->
    <div id="tab2" class="tab-content">
      <div class="filter-container">
        <div class="filter-item">
          <label for="fromDate">T·ª´ ng√†y</label>
          <input type="date" id="fromDate">
        </div>
        <div class="filter-item">
          <label for="toDate">ƒê·∫øn ng√†y</label>
          <input type="date" id="toDate">
        </div>
        <div class="filter-item">
          <label for="maSP">M√£ s·∫£n ph·∫©m</label>
          <select id="maSP"><option value="">T·∫•t c·∫£ m√£</option></select>
        </div>
        <div class="filter-item">
          <label for="searchQR">T√¨m QR Code</label>
          <input type="text" id="searchQR" placeholder="Nh·∫≠p QR Code ƒë·ªÉ l·ªçc..." oninput="applyFilters()">
        </div>
        <div class="filter-item">
          <label for="po">PO</label>
          <select id="po"><option value="">T·∫•t c·∫£ PO</option></select>
        </div>
      </div>

      <div class="button-container">
        <button class="btn-filter" onclick="applyFilters()">L·ªçc d·ªØ li·ªáu</button>
        <button class="btn-download" onclick="reloadFromGoogle()">‚≠Æ T·∫£i t·ª´ Google Sheets</button>
      </div>

      <div id="scrollArea" style="height:500px; overflow:auto; border:1px solid #ccc;">
        <table id="reportTable" style="width:100%; border-collapse:collapse;">
          <thead>
            <tr>
              <th>M√£ H√†ng</th>
              <th>QR Code</th>
              <th>Ph√°n ƒë·ªãnh</th>
              <th>M√¥ t·∫£ l·ªói</th>
              <th>Gi·ªù</th>
              <th>Ng√†y</th>
              <th>S·ªë l·∫ßn xu·∫•t hi·ªán</th>
              <th>M√£ nh√¢n vi√™n</th>
              <th>Ca</th>
              <th>PO</th>
              <th>Ghi ch√∫</th>
            </tr>
          </thead>
          <tbody id="clusterize-content" class="clusterize-content"></tbody>
        </table>

        <div id="clusterize-scroll" class="clusterize-scroll"></div>
      </div>

      <div id="recordCount" style="margin-top:5px; font-weight:bold;"></div>
    </div>
      
    <!-- Tab 3: Bi·ªÉu ƒë·ªì -->
    <div id="tab3" class="tab-content">
      <div class="chart-container">
        <h3>üìä Bi·ªÉu ƒë·ªì Pareto (theo M√¥ t·∫£ l·ªói)</h3>
        <div style="height: 400px;">
          <canvas id="paretoChart"></canvas>
        </div>
      </div>
      
      <div class="chart-container">
        <h3>üìà Bi·ªÉu ƒë·ªì so s√°nh theo ng√†y</h3>
        <div style="height: 400px;">
          <canvas id="dailyChart"></canvas>
        </div>
      </div>
    </div>
  </div>

  <script>
    // ===== BI·∫æN TO√ÄN C·ª§C =====
    let arduinoPort = null;
    let arduinoReader = null;
    let arduinoWriter = null;
    let isProcessingArduino = false;
    
    // ===== K·∫æT N·ªêI ARDUINO =====
    async function connectToArduino() {
        try {
            updateArduinoStatus("üü° ƒêang k·∫øt n·ªëi...", "connecting");
            
            const port = await navigator.serial.requestPort();
            await port.open({ baudRate: 9600 });
            
            arduinoPort = port;
            arduinoReader = port.readable.getReader();
            arduinoWriter = port.writable.getWriter();
            
            updateArduinoStatus("‚úÖ Arduino: ƒê√£ k·∫øt n·ªëi", "connected");
            console.log("‚úÖ ƒê√£ k·∫øt n·ªëi v·ªõi Arduino!");
            
            readFromArduino();
            
        } catch (error) {
            console.error("‚ùå L·ªói k·∫øt n·ªëi Arduino:", error);
            updateArduinoStatus("‚ùå L·ªói k·∫øt n·ªëi Arduino", "disconnected");
            
            if (error.name === 'NotFoundError') {
                alert("‚ö†Ô∏è Kh√¥ng t√¨m th·∫•y thi·∫øt b·ªã Arduino!");
            } else if (error.name === 'SecurityError') {
                alert("‚ö†Ô∏è Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Serial API!");
            } else {
                alert("‚ùå L·ªói k·∫øt n·ªëi: " + error.message);
            }
        }
    }
// ===== H√ÄM X√ÅC TH·ª∞C T√çN HI·ªÜU ARDUINO =====
function authenticateArduinoSignal(message) {
    // üîê CH·ªà CH·∫§P NH·∫¨N T√çN HI·ªÜU C√ì ƒê·ªäNH D·∫†NG: TESTAPP_PASS_xxx
    // Trong ƒë√≥ xxx l√† s·ªë b·∫•t k·ª≥ (timestamp t·ª´ Arduino)
    const pattern = /^TESTAPP_PASS_\d+$/;
    return pattern.test(message);
}
    // ===== H√ÄM ƒê·ªåC ARDUINO C√ì X√ÅC TH·ª∞C =====
async function readFromArduino() {
    try {
        while (arduinoPort && arduinoReader) {
            const { value, done } = await arduinoReader.read();
            if (done) break;
            
            const message = new TextDecoder().decode(value).trim();
            console.log("Nh·∫≠n t·ª´ Arduino:", message);
            
            // üîê CH·ªà X·ª¨ L√ù T√çN HI·ªÜU ƒê√É X√ÅC TH·ª∞C
            if (authenticateArduinoSignal(message) && 
                currentUser && currentUser !== "" &&
                !isProcessingArduino) {
                
                console.log("üîê Nh·∫≠n t√≠n hi·ªáu Arduino ƒë√£ x√°c th·ª±c - T·ª± ƒë·ªông k√≠ch OK...");
                isProcessingArduino = true;
                setTimeout(() => {
                    autoClickOK();
                    isProcessingArduino = false;
                }, 500);
            } else if (message.includes("PASS")) {
                console.log("üö´ T√≠n hi·ªáu kh√¥ng x√°c th·ª±c - b·ªè qua");
            }
        }
    } catch (error) {
        console.error("L·ªói ƒë·ªçc d·ªØ li·ªáu Arduino:", error);
        updateArduinoStatus("üî¥ Arduino: M·∫•t k·∫øt n·ªëi", "disconnected");
        isProcessingArduino = false;
    }
}

    // ===== H√ÄM T·ª∞ ƒê·ªòNG OK CHO ARDUINO =====
// ===== H√ÄM T·ª∞ ƒê·ªòNG OK CHO ARDUINO =====
function autoClickOK() {
    if (currentUser && currentUser !== "") {
        const mahang = document.getElementById("mahang").value;
        const qrcode = document.getElementById("qrcode").value;
        
        if (mahang && qrcode) {
            saveData('OK');
            console.log("‚úÖ ƒê√£ t·ª± ƒë·ªông nh·∫•n OK t·ª´ Arduino!");
            showTempMessage("‚úÖ T·ª± ƒë·ªông OK t·ª´ Arduino", "success");
            
            // T·ª± ƒë·ªông x√≥a v√† chu·∫©n b·ªã cho l·∫ßn qu√©t ti·∫øp
            setTimeout(() => {
                document.getElementById("qrcode").value = "";
                document.getElementById("loi").value = "";
                document.getElementById("ghichu").value = "";
                
                // Focus l·∫°i √¥ QR code
                document.getElementById("qrcode").focus();
            }, 300);
            
        } else {
            console.log("‚ö†Ô∏è Ch∆∞a c√≥ m√£ h√†ng ho·∫∑c QR code");
            showTempMessage("‚ö†Ô∏è Ch∆∞a c√≥ m√£ h√†ng ho·∫∑c QR code", "warning");
        }
    }
}
    function updateArduinoStatus(message, status) {
        const statusElement = document.getElementById("arduinoStatus");
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `arduino-status arduino-${status}`;
        }
    }

    async function disconnectArduino() {
        if (arduinoReader) {
            await arduinoReader.cancel();
            arduinoReader = null;
        }
        if (arduinoWriter) {
            await arduinoWriter.close();
            arduinoWriter = null;
        }
        if (arduinoPort) {
            await arduinoPort.close();
            arduinoPort = null;
        }
        updateArduinoStatus("üî¥ Arduino: ƒê√£ ng·∫Øt k·∫øt n·ªëi", "disconnected");
    }

    // ===== PH·∫¶N M·ªÄM TEST =====
    function autoClickOKFromSoftware() {
        console.log("üîÑ autoClickOKFromSoftware ƒë∆∞·ª£c g·ªçi");
        
        if (currentUser && currentUser !== "") {
            const mahang = document.getElementById("mahang").value;
            const qrcode = document.getElementById("qrcode").value;
            
            console.log("M√£ h√†ng:", mahang, "QR Code:", qrcode);
            
            if (mahang && qrcode) {
                saveData('OK');
                console.log("‚úÖ ƒê√£ t·ª± ƒë·ªông nh·∫•n OK t·ª´ t√≠n hi·ªáu ph·∫ßn m·ªÅm test!");
                
                showTempMessage("‚úÖ T·ª± ƒë·ªông OK t·ª´ ph·∫ßn m·ªÅm test", "success");
            } else {
                console.log("‚ö†Ô∏è Ch∆∞a c√≥ m√£ h√†ng ho·∫∑c QR code");
                showTempMessage("‚ö†Ô∏è Ch∆∞a c√≥ m√£ h√†ng ho·∫∑c QR code", "warning");
                
                setTimeout(() => {
                    const qrInput = document.getElementById("qrcode");
                    if (qrInput) {
                        qrInput.focus();
                        qrInput.select();
                    }
                }, 500);
            }
        } else {
            console.log("‚ö†Ô∏è Ch∆∞a ƒëƒÉng nh·∫≠p v√†o app");
            showTempMessage("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p tr∆∞·ªõc", "warning");
        }
    }

    function updateSoftwareStatus(message, status) {
        const statusElement = document.getElementById("softwareStatus");
        if (statusElement) {
            statusElement.textContent = message;
            statusElement.className = `software-test-status ${status}`;
        }
    }

    function testSoftwareSignal() {
        console.log("üß™ ƒêang test t√≠n hi·ªáu ph·∫ßn m·ªÅm...");
        updateSoftwareStatus("üß™ ƒêang test...", "software-waiting");
        
        setTimeout(() => {
            autoClickOKFromSoftware();
            updateSoftwareStatus("‚úÖ Test ho√†n t·∫•t", "software-ready");
        }, 1000);
    }

    // ===== S·ª∞ KI·ªÜN B√ÄN PH√çM =====
    document.addEventListener('keydown', function(event) {
        console.log("Ph√≠m nh·∫•n:", event.key, "Ctrl:", event.ctrlKey, "Shift:", event.shiftKey, "Alt:", event.altKey);
        
        // ‚úÖ T√≠n hi·ªáu PASS t·ª´ ph·∫ßn m·ªÅm - Ctrl+Shift+P
        if (event.ctrlKey && event.shiftKey && event.key === 'P') {
            event.preventDefault();
            
            console.log("üéØ Nh·∫≠n t√≠n hi·ªáu PASS t·ª´ ph·∫ßn m·ªÅm test - Ctrl+Shift+P");
            updateSoftwareStatus("üîÑ ƒêang x·ª≠ l√Ω t√≠n hi·ªáu...", "software-waiting");
            
            setTimeout(() => {
                autoClickOKFromSoftware();
                updateSoftwareStatus("‚úÖ ƒê√£ x·ª≠ l√Ω xong", "software-ready");
            }, 500);
        }
        
        // üîπ PH√çM T·∫ÆT TH·ª¶ C√îNG: Alt+O ƒë·ªÉ nh·∫•n OK
        if (event.altKey && event.key === 'O') {
            event.preventDefault();
            console.log("üéØ Nh·∫•n OK th·ªß c√¥ng - Alt+O");
            if (currentUser && currentUser !== "") {
                saveData('OK');
                console.log("‚úÖ ƒê√£ nh·∫•n OK b·∫±ng ph√≠m t·∫Øt");
                showTempMessage("‚úÖ ƒê√£ nh·∫•n OK b·∫±ng ph√≠m t·∫Øt", "success");
            }
        }
    });

    // Ch·∫∑n Enter trong √¥ QR code ƒë·ªÉ tr√°nh xung ƒë·ªôt
    document.getElementById("qrcode").addEventListener("keydown", function(event) {
        if (event.key === "Enter") {
            event.preventDefault();
            console.log("Enter b·ªã ch·∫∑n - ch·ªù t√≠n hi·ªáu Arduino ho·∫∑c nh·∫•n n√∫t OK");
        }
    });

    // ===== H√ÄM HI·ªÇN TH·ªä TH√îNG B√ÅO =====
    function showTempMessage(message, type) {
        const tempDiv = document.createElement("div");
        tempDiv.textContent = message;
        tempDiv.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 10px 15px;
            border-radius: 5px;
            color: white;
            font-weight: bold;
            z-index: 10000;
            background: ${type === 'success' ? '#27ae60' : '#e74c3c'};
        `;
        
        document.body.appendChild(tempDiv);
        setTimeout(() => tempDiv.remove(), 3000);
    }

    // ===== QU·∫¢N L√ù TAB =====
    function showTab(n) {
      document.querySelectorAll('.tab-buttons button').forEach(b => b.classList.remove('active'));
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.getElementById('btnTab' + n).classList.add('active');
      document.getElementById('tab' + n).classList.add('active');
      
      if (n === 3) {
        setTimeout(() => {
          const dataToUse = filteredDataGlobal.length > 0 ? filteredDataGlobal : allData;
          drawPareto(dataToUse);
          drawDailyChart(dataToUse);
        }, 100);
      }
      
      if (n === 2 && !window.preventAutoReload) {
        reloadFromGoogle();
      }
    }

    // ===== PH·∫¶N PH√ÅN ƒê·ªäNH S·∫¢N PH·∫®M =====
    const users = {
      "5035": "123456",
      "5624": "562411",
      "5814": "241012",
      "4549": "130417",
      "5372": "537211",
      "5171": "517111",
      "5651": "565111",
      "5531": "553111",
      "5019": "501911",
    };

    const maxLengthByProduct = {
      "ECM-2583-236": 20,
      "ECM-2583-164": 20,
      "ECM-2300": 15,
      "ECM-2310": 15,
      "IZ-1-R3": 48,
      "RM-4K-R3": 48,
      "AM-4-R3": 48,
      "P-7937": 15,
      "P-8105": 15,
      "P-8149": 15,
      "BMS 85AH": 27,
      "BMS 57AH": 27,
      "CONTROLLER": 27,
      "CAS NEMO": 12,
      "CAS MINI-DI": 15,
      "CAS MINI-485": 15,
      "BN 2573A": 12,
      "OEM": 20
    };

    let records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫","Synced"]];
    let qrCounter = {};
    let currentUser = "";
    let currentShift = "";
    let currentWO = "";
    let okCount = 0, ngCount = 0;
    let chart;

    let deliveryTarget = 0;
    let deliveryCounter = 0;

    // Load t·ª´ localStorage
    if (localStorage.getItem("records")) {
      try { 
        const savedRecords = JSON.parse(localStorage.getItem("records"));
        if (Array.isArray(savedRecords) && savedRecords.length > 0) {
          records = savedRecords;
        }
      } catch(e) { 
        console.error("L·ªói khi load records t·ª´ localStorage:", e);
      }
    }
    
    if (localStorage.getItem("qrCounter")) {
      try { 
        qrCounter = JSON.parse(localStorage.getItem("qrCounter")); 
      } catch(e) { 
        console.error("L·ªói khi load qrCounter t·ª´ localStorage:", e);
      }
    }

    function updateQRCodeMaxLength() {
      const mahang = document.getElementById("mahang").value;
      const infoElement = document.getElementById("qrcodeLengthInfo");
      
      if (mahang && maxLengthByProduct[mahang]) {
        const maxLength = maxLengthByProduct[mahang];
        infoElement.textContent = `QR Code t·ªëi ƒëa ${maxLength} k√Ω t·ª±`;
        infoElement.style.color = "#27ae60";
      } else {
        infoElement.textContent = "";
      }
    }

    function recomputeCountsForShift(shift) {
      let ok = 0, ng = 0;
      
      const latestResults = {};
      
      for (let i = 1; i < records.length; i++) {
        const row = records[i];
        if (row[8] === shift) {
          const qrcode = row[1];
          if (!latestResults[qrcode] || i > latestResults[qrcode].index) {
            latestResults[qrcode] = {
              result: row[2],
              index: i
            };
          }
        }
      }
      
      for (const qrcode in latestResults) {
        if (latestResults[qrcode].result === "OK") ok++;
        else if (latestResults[qrcode].result === "NG") ng++;
      }
      
      okCount = ok; 
      ngCount = ng;
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();
    }

    function login() {
      const uRaw = document.getElementById("loginUser").value.trim();
      const p = document.getElementById("loginPass").value.trim();
      const s = document.getElementById("shift").value;
      const wo = document.getElementById("wo").value.trim();
      
      if (!uRaw || !wo) { 
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p ƒë·∫ßy ƒë·ªß!"; 
        return; 
      }
      
      const u = uRaw.toUpperCase();
      if (users[u] && users[u] === p) {
        currentUser = u;
        currentShift = s;
        currentWO = wo;
        document.getElementById("currentUser").textContent = currentUser;
        document.getElementById("currentShift").textContent = currentShift;
        document.getElementById("currentWO").textContent = currentWO;
        document.getElementById("loginScreen").style.display = "none";
        document.getElementById("mainApp").style.display = "flex";
        recomputeCountsForShift(currentShift);
        renderTable();
      } else {
        document.getElementById("loginError").textContent = "‚ö†Ô∏è Sai t√™n ƒëƒÉng nh·∫≠p ho·∫∑c m·∫≠t kh·∫©u!";
      }
    }

    function saveData(result) {
      if (deliveryTarget === 0) {
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p S·ªê L∆Ø·ª¢NG GIAO tr∆∞·ªõc khi qu√©t!");
        return;
      }

      if (deliveryCounter >= deliveryTarget) {
        alert("‚ö†Ô∏è ƒê√£ ƒë·ªß s·ªë l∆∞·ª£ng giao, kh√¥ng th·ªÉ qu√©t th√™m!");
        return;
      }

      const mahang = document.getElementById("mahang").value.trim().toUpperCase();
      const qrcode = document.getElementById("qrcode").value.trim().toUpperCase();
      const loi = document.getElementById("loi").value.trim();
      const ghichu = document.getElementById("ghichu").value.trim();

      if (!mahang || !qrcode) {
        document.getElementById("error").textContent = "‚ö†Ô∏è Vui l√≤ng nh·∫≠p M√£ h√†ng v√† QR Code!";
        return;
      }
      
      const maxLength = maxLengthByProduct[mahang];
      if (maxLength && qrcode.length > maxLength) {
        alert(`‚ö†Ô∏è QR Code cho m√£ h√†ng ${mahang} v∆∞·ª£t qu√° ${maxLength} k√Ω t·ª±! Vui l√≤ng qu√©t l·∫°i!`);
        document.getElementById("qrcode").value = "";
        document.getElementById("qrcode").focus();
        return;
      }

      document.getElementById("error").textContent = "";

      qrCounter[qrcode] = (qrCounter[qrcode] || 0) + 1;
      const now = new Date();
      const gio = now.toLocaleTimeString("vi-VN");
      const ngay = now.toLocaleDateString("vi-VN");

      let oldOkCount = 0, oldNgCount = 0;
      for (let i = 1; i < records.length; i++) {
        if (records[i][1] === qrcode) {
          if (records[i][2] === "OK") oldOkCount++;
          else if (records[i][2] === "NG") oldNgCount++;
        }
      }

      okCount = okCount - oldOkCount;
      ngCount = ngCount - oldNgCount;
      
      if (result === "OK") okCount++;
      else ngCount++;

      records.push([
        mahang,
        qrcode,
        result,
        loi,
        gio,
        ngay,
        qrCounter[qrcode],
        currentUser,
        currentShift,
        currentWO,
        ghichu,
        false
      ]);

      saveLocal();
      renderTable();
      document.getElementById("okCount").textContent = okCount;
      document.getElementById("ngCount").textContent = ngCount;
      updateChart();

      document.getElementById("qrcode").value = "";
      document.getElementById("loi").value = "";
      document.getElementById("ghichu").value = "";
      
      deliveryCounter++;
      document.getElementById("deliveryStatus").textContent = `ƒê√£ qu√©t ${deliveryCounter}/${deliveryTarget}`;

      if (deliveryCounter >= deliveryTarget) {
        alert(`‚úÖ ƒê√£ ƒë·ªß ${deliveryTarget} s·∫£n ph·∫©m!`);
        document.getElementById("deliveryQty").value = 0;
        deliveryTarget = 0;
        deliveryCounter = 0;
        document.getElementById("deliveryStatus").textContent = "";
      }

      const qEl = document.getElementById("qrcode");
      if (qEl) {
        qEl.focus();
        qEl.select();
      }
      syncToSheet();
    }

    function renderTable() {
      const tbody = document.getElementById("logTable").getElementsByTagName("tbody")[0];
      tbody.innerHTML = "";

      const search = document.getElementById("searchBox").value.toLowerCase();
      const filterRes = document.getElementById("filterResult").value;

      for (let i = records.length - 1; i >= 1; i--) {
        const rowData = records[i];
        
        if (search && !rowData[0].toLowerCase().includes(search) && !rowData[1].toLowerCase().includes(search)) continue;
        if (filterRes && rowData[2] !== filterRes) continue;

        const tr = tbody.insertRow();
        
        let bgColor = "white";
        if (rowData[2] === "NG") {
          bgColor = "red";
        } else if (rowData[2] === "OK") {
          const hasPreviousNG = checkIfHasPreviousNG(rowData[1], i);
          if (hasPreviousNG) {
            bgColor = "#27ae60";
          } else {
            bgColor = "white";
          }
        }
        tr.style.backgroundColor = bgColor;

        for (let j = 0; j < 11; j++) {
          const td = tr.insertCell();
          td.textContent = rowData[j] || "";
        }

        const tdDel = tr.insertCell();
        const btn = document.createElement("button");
        btn.textContent = "X√≥a";
        btn.style.background = "#e74c3c";
        btn.style.color = "white";
        btn.style.border = "none";
        btn.style.padding = "4px 8px";
        btn.style.borderRadius = "4px";
        btn.onclick = () => deleteRecord(i);
        tdDel.appendChild(btn);

        if ((rowData[6] || 0) > 1) tr.classList.add("duplicate");
      }
    }

    function checkIfHasPreviousNG(qrcode, currentIndex) {
      for (let i = currentIndex - 1; i >= 1; i--) {
        if (records[i][1] === qrcode && records[i][2] === "NG") {
          return true;
        }
      }
      return false;
    }

    function saveLocal() {
      try {
        localStorage.setItem("records", JSON.stringify(records));
        localStorage.setItem("qrCounter", JSON.stringify(qrCounter));
      } catch(e) { 
        console.warn("L∆∞u localStorage th·∫•t b·∫°i:", e); 
      }
    }

    function exportCSV() {
      if (!currentShift || !currentWO) {
        alert("‚ö†Ô∏è Vui l√≤ng ƒëƒÉng nh·∫≠p v√† ch·ªçn ca + WO tr∆∞·ªõc khi xu·∫•t file!");
        return;
      }

      let mahang = document.getElementById("mahang").value.trim();
      if (!mahang) { 
        alert("‚ö†Ô∏è Vui l√≤ng nh·∫≠p m√£ h√†ng tr∆∞·ªõc khi xu·∫•t file!"); 
        return; 
      }

      let filteredRecords = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫"]];
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          filteredRecords.push(records[i]);
        }
      }

      if (filteredRecords.length <= 1) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu n√†o cho ca n√†y!");
        return;
      }

      let now = new Date();
      let filename = `${mahang}_${currentShift.replace(/\s+/g, "_")}_${now.getFullYear()}-${now.getMonth()+1}-${now.getDate()}.csv`;

      let csvContent = "\uFEFF" + filteredRecords.map(e => e.join(",")).join("\n");
      let blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      let link = document.createElement("a");
      if (link.download !== undefined) {
        let url = URL.createObjectURL(blob);
        link.setAttribute("href", url);
        link.setAttribute("download", filename);
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      }
    }

    function syncToSheet() {
      const sheetUrl = "https://script.google.com/macros/s/AKfycbwGCEDo7faBhEh9FCv1ZlrfINyAvfwIg9EbXk-CqwZRYBKVOQJP2hIGjI02JbeWIYJC5A/exec"; 
      
      const dataToSend = records
      .slice(1)
      .filter(r => !r[11]);

      if (dataToSend.length === 0) {
        alert("‚ö†Ô∏è Kh√¥ng c√≥ d·ªØ li·ªáu ƒë·ªÉ ƒë·ªìng b·ªô!");
        return;
      }

      console.log("D·ªØ li·ªáu g·ª≠i l√™n Google Sheets:", dataToSend);

      fetch(sheetUrl, {
        method: "POST",
        body: JSON.stringify(dataToSend),
        headers: { "Content-Type": "application/json" },
        mode: "no-cors"
      })
      .then(() => {
      alert("‚úÖ ƒê√£ g·ª≠i d·ªØ li·ªáu l√™n Google Sheets");

      records = records.map(r => {
        if (r[11] === false) r[11] = true;
        return r;
      });
      saveLocal();

      console.log("ƒê√£ ƒë√°nh d·∫•u synced:", records);
    })
      .catch(err => {
        alert("‚ùå L·ªói ƒë·ªìng b·ªô: " + err);
        console.error("L·ªói g·ª≠i d·ªØ li·ªáu:", err);
      });
    }

    function endShiftReport() {
      let summary = {};
      for (let i = 1; i < records.length; i++) {
        if (records[i][8] === currentShift && records[i][9] === currentWO) {
          let mahang = records[i][0];
          let result = records[i][2];
          let loi = records[i][3];

          if (!summary[mahang]) {
            summary[mahang] = { ok: 0, ng: 0, loiCount: {} };
          }

          if (result === "OK") {
            summary[mahang].ok++;
          } else if (result === "NG") {
            summary[mahang].ng++;
            summary[mahang].loiCount[loi] = (summary[mahang].loiCount[loi] || 0) + 1;
          }
        }
      }

      let report = `üìä B√°o c√°o ca ${currentShift} (WO: ${currentWO}):\n`;
      for (let mahang in summary) {
        let ok = summary[mahang].ok;
        let ng = summary[mahang].ng;
        let total = ok + ng;
        let tyLeNG = total ? ((ng / total) * 100).toFixed(2) : 0;
        let top3 = Object.entries(summary[mahang].loiCount)
                         .sort((a,b)=>b[1]-a[1])
                         .slice(0,3)
                         .map(x => `${x[0]}(${x[1]})`)
                         .join(", ") || "Kh√¥ng c√≥";

        report += `\nüì¶ M√£ h√†ng: ${mahang}\n‚úÖ OK: ${ok} | ‚ùå NG: ${ng} | üìâ T·ª∑ l·ªá NG: ${tyLeNG}%\nüî• Top l·ªói: ${top3}\n`;
      }

      alert(report);
    }

    function updateChart() {
      const canvas = document.getElementById("chartOKNG");
      if (!canvas) return;
      
      const ctx = canvas.getContext("2d");
      if (chart) chart.destroy();
      
      try {
        chart = new Chart(ctx, {
          type: "doughnut",
          data: {
            labels: ["OK", "NG"],
            datasets: [{
              data: [okCount, ngCount],
              backgroundColor: ["#2ecc71", "#e74c3c"]
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            cutout: "50%",
            radius: "90%",
            plugins: { 
              legend: { 
                position: "right",
                labels: {
                  usePointStyle: true,
                  padding: 20
                }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o bi·ªÉu ƒë·ªì:", e);
      }
    }

    function clearLogDisplay() {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a b·∫£ng hi·ªÉn th·ªã? (D·ªØ li·ªáu v·∫´n c√≤n l∆∞u trong b·ªô nh·ªõ)")) return;
      document.querySelector("#logTable tbody").innerHTML = "";
      alert("‚úÖ ƒê√£ x√≥a hi·ªÉn th·ªã log. D·ªØ li·ªáu g·ªëc v·∫´n c√≤n!");
    }

    function resetAllData() {
      if (!confirm("‚ö†Ô∏è B·∫°n c√≥ ch·∫Øc mu·ªën X√ìA TO√ÄN B·ªò d·ªØ li·ªáu (records + b·ªô ƒë·∫øm)?")) return;

      const backupKey = "backup_records_" + (new Date()).toISOString();
      try {
        localStorage.setItem(backupKey, JSON.stringify(records));
        localStorage.setItem(backupKey + "_qr", JSON.stringify(qrCounter));
      } catch(e) { console.warn("Backup th·∫•t b·∫°i:", e); }

      records = [["M√£ h√†ng","QR Code","K·∫øt qu·∫£","L·ªói","Gi·ªù","Ng√†y","S·ªë l·∫ßn xu·∫•t hi·ªán","Ng∆∞·ªùi ki·ªÉm tra","Ca","WO","Ghi ch√∫"]];
      qrCounter = {};
      okCount = 0; ngCount = 0;
      saveLocal();

      renderTable();
      recomputeCountsForShift(currentShift || "");
      alert("‚úÖ ƒê√£ reset d·ªØ li·ªáu. B·∫£n backup ƒë√£ l∆∞u v√†o localStorage v·ªõi key: " + backupKey);
    }

    function deleteRecord(index) {
      if (!confirm("B·∫°n c√≥ ch·∫Øc mu·ªën x√≥a d√≤ng n√†y?")) return;

      index = Number(index);
      if (isNaN(index) || index < 1 || index >= records.length) {
        alert("Kh√¥ng t√¨m th·∫•y b·∫£n ghi ƒë·ªÉ x√≥a.");
        return;
      }

      const removed = records.splice(index, 1)[0];
      const removedQr = removed[1];
      
      recomputeCountsForShift(currentShift);
      
      saveLocal();
      renderTable();
    }

    // ===== PH·∫¶N B√ÅO C√ÅO & TH·ªêNG K√ä =====
    const API_URL = "https://script.google.com/macros/s/AKfycbwGCEDo7faBhEh9FCv1ZlrfINyAvfwIg9EbXk-CqwZRYBKVOQJP2hIGjI02JbeWIYJC5A/exec";
    let allData = [];
    let filteredDataGlobal = [];
    let paretoChart, dailyChart;
    let clusterize = null;

    function parseDateString(str){
      if(!str) return null;
      str = str.toString().trim();

      const m1 = str.match(/^(\d{1,2})[\/\-](\d{1,2})[\/\-](\d{4})$/);
      if(m1){
        const d = parseInt(m1[1],10);
        const m = parseInt(m1[2],10) - 1;
        const y = parseInt(m1[3],10);
        const date = new Date(y, m, d, 12, 0, 0);
        return date;
      }

      const m2 = str.match(/^(\d{4})[\/\-](\d{1,2})[\/\-](\d{1,2})$/);
      if(m2){
        const y = parseInt(m2[1],10);
        const m = parseInt(m2[2],10)-1;
        const d = parseInt(m2[3],10);
        return new Date(y,m,d,12,0,0);
      }

      const d2 = new Date(str);
      if(!isNaN(d2)) return new Date(d2.getFullYear(), d2.getMonth(), d2.getDate(), 12, 0, 0);

      return null;
    }

    function isoDate(d){
      if (!(d instanceof Date) || isNaN(d)) return null;
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, '0');
      const dd = String(d.getDate()).padStart(2, '0');
      return `${y}-${m}-${dd}`;
    }

    function populateFilters(data){
      const maSPs = new Set();
      const pos = new Set();
      data.forEach(r=>{
        if (r.maHang) maSPs.add(r.maHang);
        if (r.po) pos.add(r.po);
      });
      fillSelect("maSP",maSPs);
      fillSelect("po",pos);
    }

    function fillSelect(id, values){
      const select = document.getElementById(id);
      select.innerHTML = `<option value="">T·∫•t c·∫£</option>`;
      values.forEach(v=>select.innerHTML+=`<option value="${v}">${v}</option>`);
    }

    function reloadFromGoogle(){
      fetch(API_URL)
        .then(res=>{
          if (!res.ok) {
            throw new Error(`HTTP error! status: ${res.status}`);
          }
          return res.json();
        })
        .then(data=>{
          allData = data || [];
          populateFilters(allData);
          renderReportTable(allData);
          
          if (allData.length > 0) {
            setTimeout(() => {
              drawPareto(allData);
              drawDailyChart(allData);
            }, 100);
          }
        })
        .catch(err=>{
          console.error("Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu:", err);
          alert("‚ùå Kh√¥ng l·∫•y ƒë∆∞·ª£c d·ªØ li·ªáu: " + err.message);
        });
    }

    function applyFilters() {
      window.preventAutoReload = true;
      const searchQR = document.getElementById("searchQR").value.trim().toUpperCase();
      const fromDate = document.getElementById("fromDate").value;
      const toDate = document.getElementById("toDate").value;
      const maSP = document.getElementById("maSP").value;
      const po = document.getElementById("po").value;

      filteredDataGlobal = allData.filter(r => {
        let match = true;

        const qrValue =
          r["QR Code"] || r["Qr code"] || r["QR code"] || r.qrCode || r.qr || "";
        const maHangValue = r["M√£ h√†ng"] || r.maHang || "";
        const poValue = r["PO"] || r.po || "";
        const ngayStr = r["Ng√†y"] || r.ngay;
        const ngay = parseDateString(ngayStr);

        if (searchQR && !qrValue.toString().toUpperCase().includes(searchQR)) match = false;
        if (maSP && maHangValue !== maSP) match = false;
        if (po && poValue !== po) match = false;

        if (fromDate && ngay < new Date(fromDate)) match = false;
        if (toDate) {
          const to = new Date(toDate);
          to.setHours(23, 59, 59, 999);
          if (ngay > to) match = false;
        }

        return match;
      });

      renderReportTable(filteredDataGlobal);
      
      drawPareto(filteredDataGlobal);
      drawDailyChart(filteredDataGlobal);
      
      alert(`‚úÖ ƒê√£ l·ªçc ƒë∆∞·ª£c ${filteredDataGlobal.length} d√≤ng. Bi·ªÉu ƒë·ªì ƒë√£ ƒë∆∞·ª£c c·∫≠p nh·∫≠t!`);
    }

    function renderReportTable(data) {
      const rows = data.map(r => {
        let gioRaw = r["Gi·ªù"] || r.gio || "";
        let ngayRaw = r["Ng√†y"] || r.ngay || "";

        function formatDateTime(value, type="date") {
          if (!value) return "";
          try {
            const d = new Date(value);
            if (isNaN(d)) return value;
            if (type === "time") return d.toLocaleTimeString("vi-VN", { hour12: false });
            return d.toLocaleDateString("vi-VN");
          } catch {
            return value;
          }
        }

        const gio = formatDateTime(gioRaw, "time");
        const ngay = formatDateTime(ngayRaw, "date");

        return `
          <tr>
            <td>${r["M√£ h√†ng"] || r.maHang || ""}</td>
            <td>${r["QR code"] || r.qrCode || ""}</td>
            <td>${r["Ph√°n ƒë·ªãnh"] || r.phanDinh || ""}</td>
            <td>${r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || ""}</td>
            <td>${gio}</td>
            <td>${ngay}</td>
            <td>${r["S·ªë l·∫ßn xu·∫•t hi·ªán"] || r.soLan || ""}</td>
            <td>${r["M√£ Nh√¢n Vi√™n"] || r.maNV || r.User || ""}</td>
            <td>${r["Ca l√†m vi·ªác"] || r.caLam || r.Shift || ""}</td>
            <td>${r["PO"] || r.po || ""}</td>
            <td>${r["Ghi ch√∫"] || r.ghichu || ""}</td>
          </tr>
        `;
      });

      if (!clusterize) {
        clusterize = new Clusterize({
          rows: rows,
          scrollId: 'scrollArea',
          contentId: 'clusterize-content'
        });
      } else {
        clusterize.update(rows);
      }

      const info = document.getElementById("recordCount");
      if (info) info.textContent = `T·ªïng: ${data.length} d√≤ng`;
    }

    function drawPareto(data){
      const canvas = document.getElementById("paretoChart");
      if (!canvas) {
        console.error("Kh√¥ng t√¨m th·∫•y canvas paretoChart");
        return;
      }

      const ctx = canvas.getContext("2d");
      if (!ctx) {
        console.error("Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas");
        return;
      }

      const loiCount = {};
      data.forEach(r=>{
        const moTaLoi = r["M√¥ t·∫£ l·ªói"] || r.moTaLoi || "";
        const phanDinh = r["Ph√°n ƒë·ªãnh"] || r.phanDinh || "";
        
        if (moTaLoi && phanDinh === "NG") {
          loiCount[moTaLoi] = (loiCount[moTaLoi] || 0) + 1;
        }
      });
      
      const loiSorted = Object.entries(loiCount).sort((a,b)=>b[1]-a[1]);
      const labels = loiSorted.map(x=>x[0]);
      const values = loiSorted.map(x=>x[1]);
      const total = values.reduce((a,b)=>a+b,0);
      const cumsum = values.map((sum=>v=>sum+=v)(0));
      const cumPerc = cumsum.map(s=>(s/total*100).toFixed(1));

      if (paretoChart) {
        try {
          paretoChart.destroy();
        } catch(e) {
          console.warn("L·ªói khi destroy paretoChart c≈©:", e);
        }
      }

      try {
        paretoChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: labels,
            datasets: [{
              label: "S·ªë l·ªói",
              data: values,
              backgroundColor: "#3498db",
              order: 2
            },{
              label: "T·ª∑ l·ªá t√≠ch l≈©y (%)",
              data: cumPerc,
              type: "line",
              borderColor: "#e74c3c",
              backgroundColor: "rgba(231,76,60,0.1)",
              fill: true,
              yAxisID: "y1",
              order: 1
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "S·ªë l·ªói" }
              },
              y1: {
                position: "right",
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "T·ª∑ l·ªá %" },
                grid: { drawOnChartArea: false }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o paretoChart:", e);
      }
    }

    function drawDailyChart(data) {
      const canvas = document.getElementById("dailyChart");
      if (!canvas) {
        console.error("Kh√¥ng t√¨m th·∫•y canvas dailyChart");
        return;
      }

      const ctx = canvas.getContext("2d");
      if (!ctx) {
        console.error("Kh√¥ng th·ªÉ l·∫•y context t·ª´ canvas");
        return;
      }

      const dailyCount = {};
      let minDate = null, maxDate = null;

      data.forEach(r => {
        const ngayStr = r["Ng√†y"] || r.ngay;
        const phanDinh = r["Ph√°n ƒë·ªãnh"] || r.phanDinh || "";
        
        if (ngayStr) {
          const d = parseDateString(ngayStr);
          if (d) {
            if (!minDate || d < minDate) minDate = d;
            if (!maxDate || d > maxDate) maxDate = d;

            const iso = isoDate(d);
            if (!dailyCount[iso]) dailyCount[iso] = { ok: 0, ng: 0 };
            if (phanDinh === "OK") dailyCount[iso].ok++;
            else if (phanDinh === "NG") dailyCount[iso].ng++;
          }
        }
      });

      const dates = [];
      if (minDate && maxDate) {
        let cur = new Date(minDate);
        while (cur <= maxDate) {
          dates.push(isoDate(cur));
          cur.setDate(cur.getDate() + 1);
        }
      }

      const okData = dates.map(d => dailyCount[d]?.ok || 0);
      const ngData = dates.map(d => dailyCount[d]?.ng || 0);
      const totalData = dates.map(d => (dailyCount[d]?.ok || 0) + (dailyCount[d]?.ng || 0));

      const percNG = dates.map(d => {
        const total = (dailyCount[d]?.ok || 0) + (dailyCount[d]?.ng || 0);
        return total > 0 ? ((dailyCount[d].ng / total) * 100).toFixed(2) : 0;
      });

      if (dailyChart) {
        try {
          dailyChart.destroy();
        } catch(e) {
          console.warn("L·ªói khi destroy dailyChart c≈©:", e);
        }
      }

      try {
        dailyChart = new Chart(ctx, {
          type: "bar",
          data: {
            labels: dates,
            datasets: [
              {
                label: "T·ªïng s·ªë l∆∞·ª£ng",
                data: totalData,
                backgroundColor: "#2ecc71",
                yAxisID: "y",
              },
              {
                label: "NG",
                data: ngData,
                backgroundColor: "#e74c3c",
                yAxisID: "y",
              },
              {
                label: "% NG/T·ªïng",
                data: percNG,
                type: "line",
                borderColor: "#2980b9",
                backgroundColor: "rgba(52,152,219,0.1)",
                yAxisID: "y1",
                tension: 0.3,
                fill: false,
              }
            ]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            scales: {
              y: {
                beginAtZero: true,
                title: { display: true, text: "S·ªë l∆∞·ª£ng" }
              },
              y1: {
                position: "right",
                beginAtZero: true,
                max: 100,
                title: { display: true, text: "% NG" },
                grid: { drawOnChartArea: false }
              },
              x: {
                title: { display: true, text: "Ng√†y" }
              }
            }
          }
        });
      } catch(e) {
        console.error("L·ªói khi t·∫°o dailyChart:", e);
      }
    }

    // ===== KH·ªûI T·∫†O =====
    window.onload = function() {
      recomputeCountsForShift(currentShift || "");
      renderTable();
      updateChart();

      document.getElementById("deliveryQty").addEventListener("input", ()=>{
        deliveryTarget = parseInt(document.getElementById("deliveryQty").value) || 0;
        deliveryCounter = 0;
        if (deliveryTarget > 0) {
          document.getElementById("deliveryStatus").textContent = `üîÑ ƒê√£ ƒë·∫∑t m·ª•c ti√™u: ${deliveryTarget}`;
        } else {
          document.getElementById("deliveryStatus").textContent = "";
        }
      });

      window.addEventListener("storage", (event) => {
        if (event.key === "records") {
          records = JSON.parse(event.newValue || "[]");
          renderTable();
          recomputeCountsForShift(currentShift || "");
        }
      });
    }
  </script>
</body>
</html>